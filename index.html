<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Echoes After Pandemic</title>
<style>
body{margin:0;background:#000;display:flex;justify-content:center;align-items:center;height:100vh}
canvas{image-rendering:pixelated;border:3px solid #333}
</style>
</head>
<body>

<canvas id="game" width="640" height="480"></canvas>

<script>
const c=document.getElementById("game"),ctx=c.getContext("2d");

/* ================= CONTROLES ================= */
const k={};
document.addEventListener("keydown",e=>k[e.key.toLowerCase()]=true);
document.addEventListener("keyup",e=>k[e.key.toLowerCase()]=false);

/* ================= ESTADO ================= */
let room=1,state="game",gameOver=false;
let rage=false,dogAlive=true;

/* ================= PLAYER ================= */
const p={x:320,y:380,life:100,speed:2};

/* ================= CACHORRO ================= */
const dog={x:300,y:400};

/* ================= INIMIGOS ================= */
let zombies=[],bullets=[],enemyShots=[];

/* ================= BOSS ================= */
const boss={x:320,y:140,life1:250,life2:250,spawn:80,throw:40};

/* ================= FUNÇÕES ================= */
function spawnZombies(n){
  zombies=[];
  for(let i=0;i<n;i++){
    zombies.push({
      x:Math.random()*560+40,
      y:Math.random()*260+80,
      life:30,atk:0,throw:90
    });
  }
}
spawnZombies(10);

/* ================= UPDATE ================= */
function update(){
  if(gameOver){
    if(k["enter"])location.reload();
    return;
  }

  let sp=p.speed*(rage?2:1);
  if(k["w"])p.y-=sp;
  if(k["s"])p.y+=sp;
  if(k["a"])p.x-=sp;
  if(k["d"])p.x+=sp;

  if(k[" "]){
    bullets.push({x:p.x,y:p.y});
    k[" "]=false;
  }

  bullets.forEach(b=>b.y-=6);

  if(dogAlive){
    dog.x+=(p.x-dog.x)*0.05;
    dog.y+=(p.y-dog.y)*0.05;
  }

  zombies.forEach(z=>{
    const dx=p.x-z.x,dy=p.y-z.y,d=Math.hypot(dx,dy);
    z.x+=dx/d*0.5; z.y+=dy/d*0.5;

    if(d<18 && z.atk<=0){
      p.life-=8;
      z.atk=30;
    }
    if(z.atk>0)z.atk--;

    z.throw--;
    if(z.throw<=0){
      enemyShots.push({x:z.x,y:z.y,vx:dx/d*3,vy:dy/d*3});
      z.throw=100;
    }
  });

  enemyShots.forEach((s,i)=>{
    s.x+=s.vx; s.y+=s.vy;
    if(Math.abs(s.x-p.x)<10 && Math.abs(s.y-p.y)<10){
      p.life-=6;
      enemyShots.splice(i,1);
    }
  });

  bullets.forEach((b,i)=>{
    zombies.forEach((z,zi)=>{
      if(Math.abs(b.x-z.x)<8){
        z.life-=10;
        bullets.splice(i,1);
        if(z.life<=0)zombies.splice(zi,1);
      }
    });
  });

  if(zombies.length===0 && room<4){
    room++;
    spawnZombies(10);
  }

  if(room===4){
    const dx=p.x-boss.x,dy=p.y-boss.y,d=Math.hypot(dx,dy);
    boss.x+=dx/d*0.4; boss.y+=dy/d*0.4;

    boss.throw--;
    if(boss.throw<=0){
      enemyShots.push({x:boss.x,y:boss.y,vx:dx/d*4,vy:dy/d*4});
      boss.throw=25;
    }

    bullets.forEach((b,i)=>{
      if(Math.abs(b.x-boss.x)<20){
        if(boss.life1>0)boss.life1-=8;
        else boss.life2-=8;
        bullets.splice(i,1);
      }
    });

    zombies.forEach(z=>{
      if(dogAlive && Math.abs(z.x-p.x)<20){
        dogAlive=false;
        rage=true;
      }
    });
  }

  if(p.life<=0){
    gameOver=true;
  }
}

/* ================= CENÁRIOS ================= */
function drawScenario(){
  if(room===1){
    ctx.fillStyle="#2f2f2f";ctx.fillRect(0,0,640,480);
    for(let i=0;i<8;i++){
      ctx.fillStyle="#444";
      ctx.fillRect(i*80,300,60,20);
    }
  }
  if(room===2){
    ctx.fillStyle="#3a3a3a";ctx.fillRect(0,0,640,480);
    for(let i=0;i<6;i++){
      ctx.fillStyle="#555";
      ctx.fillRect(i*100+20,200,40,80);
    }
  }
  if(room===3){
    ctx.fillStyle="#1f2a2f";ctx.fillRect(0,0,640,480);
    for(let i=0;i<6;i++){
      ctx.fillStyle="#2ecc71";
      ctx.fillRect(i*100+30,260,30,30);
    }
  }
  if(room===4){
    ctx.fillStyle="#120909";ctx.fillRect(0,0,640,480);
    for(let i=0;i<20;i++){
      ctx.fillStyle="#2a0000";
      ctx.fillRect(Math.random()*640,Math.random()*480,4,4);
    }
  }
}

/* ================= DRAW ================= */
function draw(){
  drawScenario();

  if(rage){
    ctx.strokeStyle="red";
    ctx.beginPath();
    ctx.arc(p.x,p.y,30,0,Math.PI*2);
    ctx.stroke();
  }

  ctx.fillStyle="#e0c097";
  ctx.fillRect(p.x-6,p.y-12,12,12);
  ctx.fillStyle="#555";
  ctx.fillRect(p.x-6,p.y,12,10);

  if(dogAlive){
    ctx.fillStyle="#b5651d";
    ctx.fillRect(dog.x-6,dog.y-4,12,6);
  }

  zombies.forEach(z=>{
    ctx.fillStyle="#3fa34d";
    ctx.fillRect(z.x-5,z.y-5,10,10);
  });

  if(room===4){
    ctx.fillStyle="#7b1e1e";
    ctx.fillRect(boss.x-20,boss.y-20,40,40);
  }

  enemyShots.forEach(s=>{
    ctx.fillStyle="#aaa";
    ctx.fillRect(s.x,s.y,4,4);
  });

  bullets.forEach(b=>{
    ctx.fillStyle="#ff0";
    ctx.fillRect(b.x,b.y,4,4);
  });

  ctx.fillStyle="#fff";
  ctx.fillText("Vida: "+p.life,10,20);
  ctx.fillText("Sala: "+room,10,40);

  if(gameOver){
    ctx.fillStyle="rgba(0,0,0,0.8)";
    ctx.fillRect(0,0,640,480);
    ctx.fillStyle="#f00";
    ctx.fillText("GAME OVER",280,220);
    ctx.fillStyle="#fff";
    ctx.fillText("Pressione ENTER para reiniciar",200,260);
  }
}

/* ================= LOOP ================= */
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>

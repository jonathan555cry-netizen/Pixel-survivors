const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = 640;
canvas.height = 360;

/* ===== ASSETS ===== */
const sprites = {
  player: new Image(),
  enemy: new Image(),
  boss: new Image(),
  bike: new Image()
};

sprites.player.src = "assets/sprites/player.png";
sprites.enemy.src = "assets/sprites/enemy.png";
sprites.boss.src = "assets/sprites/boss.png";
sprites.bike.src = "assets/sprites/bike.png";

/* ===== AUDIO ===== */
const audio = {
  bgm: new Audio("assets/audio/bgm.mp3"),
  engine: new Audio("assets/audio/engine.mp3"),
  boss: new Audio("assets/audio/boss.mp3"),
  victory: new Audio("assets/audio/victory.mp3"),
  shot: new Audio("assets/audio/shot.wav")
};

audio.bgm.loop = true;
audio.engine.loop = true;

/* ===== MUNDO ===== */
const world = { width: 2000, height: 2000 };
const camera = { x: 0, y: 0 };

/* ===== PLAYER ===== */
const player = {
  x: 1000,
  y: 1000,
  size: 24,
  speed: 2,
  life: 100,
  ammo: 20,
  medkits: 1,
  onBike: false
};

/* ===== MOTO ===== */
const bike = {
  x: 1200,
  y: 1000,
  size: 32,
  active: true
};

/* ===== CONTROLES ===== */
const keys = {};
document.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
document.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

/* ===== TIROS ===== */
let bullets = [];

/* ===== INIMIGOS ===== */
let enemies = [];
let boss = null;
let gameEnd = false;
let cutscene = false;

/* ===== SPAWN ===== */
function spawnEnemies() {
  for (let i = 0; i < 12; i++) {
    enemies.push({
      x: Math.random() * world.width,
      y: Math.random() * world.height,
      size: 24,
      life: 40,
      speed: 0.5
    });
  }
}

function spawnBoss() {
  boss = {
    x: world.width / 2,
    y: world.height / 2,
    size: 48,
    life: 300,
    speed: 0.4
  };
  audio.bgm.pause();
  audio.boss.play();
}

spawnEnemies();
audio.bgm.play();

/* ===== INPUT ===== */
document.addEventListener("keydown", e => {
  if (e.code === "Space" && player.ammo > 0) {
    bullets.push({ x: player.x, y: player.y, dx: 5 });
    player.ammo--;
    audio.shot.play();
  }
});

/* ===== UPDATE ===== */
function update() {
  if (cutscene) return;

  let speed = player.onBike ? 4 : 2;

  if (keys["w"]) player.y -= speed;
  if (keys["s"]) player.y += speed;
  if (keys["a"]) player.x -= speed;
  if (keys["d"]) player.x += speed;

  if (
    bike.active &&
    Math.abs(player.x - bike.x) < 30 &&
    Math.abs(player.y - bike.y) < 30 &&
    keys["e"]
  ) {
    player.onBike = true;
    bike.active = false;
    audio.engine.play();
  }

  bullets.forEach(b => b.x += b.dx);

  enemies.forEach((e, i) => {
    if (e.x < player.x) e.x += e.speed;
    if (e.x > player.x) e.x -= e.speed;
    if (e.y < player.y) e.y += e.speed;
    if (e.y > player.y) e.y -= e.speed;

    bullets.forEach((b, bi) => {
      if (Math.abs(b.x - e.x) < 16 && Math.abs(b.y - e.y) < 16) {
        e.life -= 20;
        bullets.splice(bi, 1);
        if (e.life <= 0) enemies.splice(i, 1);
      }
    });
  });

  if (enemies.length === 0 && !boss) spawnBoss();

  if (boss) {
    if (boss.x < player.x) boss.x += boss.speed;
    if (boss.x > player.x) boss.x -= boss.speed;

    bullets.forEach((b, bi) => {
      if (Math.abs(b.x - boss.x) < 32) {
        boss.life -= 10;
        bullets.splice(bi, 1);
        if (boss.life <= 0) {
          audio.boss.pause();
          audio.victory.play();
          cutscene = true;
        }
      }
    });
  }

  camera.x = player.x - canvas.width / 2;
  camera.y = player.y - canvas.height / 2;
}

/* ===== DRAW ===== */
function draw() {
  ctx.fillStyle = "#1b1b1b";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  ctx.save();
  ctx.translate(-camera.x, -camera.y);

  if (bike.active)
    ctx.drawImage(sprites.bike, bike.x, bike.y, 32, 32);

  ctx.drawImage(
    sprites.player,
    player.x,
    player.y,
    player.size,
    player.size
  );

  enemies.forEach(e =>
    ctx.drawImage(sprites.enemy, e.x, e.y, e.size, e.size)
  );

  if (boss)
    ctx.drawImage(sprites.boss, boss.x, boss.y, boss.size, boss.size);

  ctx.restore();

  if (cutscene) {
    ctx.fillStyle = "rgba(0,0,0,0.85)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#fff";
    ctx.font = "18px monospace";
    ctx.fillText("O mundo ainda pode ser salvo...", 120, 160);
    ctx.fillText("Criado por Jonathan Pereira", 160, 200);
  }
}

/* ===== LOOP ===== */
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}

loop();
